AWSTemplateFormatVersion: '2010-09-09'

Description: |
  Oracle Database 26ai Enterprise Edition on Amazon EC2
  Production-Ready Deployment | Oracle Linux 9 | Automated Installation
  Version: 2.0 | Author: Sebas Jaramillo | BYOL License Model
  
  Features:
  - Fully automated OUI silent install + DBCA
  - Encrypted EBS volumes with optimized IOPS
  - AWS Secrets Manager integration for credentials
  - CloudWatch monitoring and alerting
  - Automated RMAN backups to S3
  - Session Manager access (no SSH keys required)
  - Multi-AZ deployment ready

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: "ðŸŒ Network Configuration"
        Parameters:
          - VpcId
          - SubnetId
          - AllowedCidrSSH
          - AllowedCidrDB
      - Label:
          default: "ðŸ’» EC2 Instance Configuration"
        Parameters:
          - InstanceType
          - KeyName
      - Label:
          default: "ðŸ“¦ Oracle Software Source"
        Parameters:
          - S3BucketName
          - S3SoftwareKey
      - Label:
          default: "ðŸ” Database Credentials"
        Parameters:
          - UseSecretsManager
          - DbSysPassword
          - DbSystemPassword
          - DbPdbAdminPassword
      - Label:
          default: "ðŸ’¾ Storage Configuration"
        Parameters:
          - VolumeSizeOS
          - VolumeSizeU01
          - VolumeSizeU02
          - VolumeSizeU03
          - VolumeSizeU04
      - Label:
          default: "ðŸ—„ï¸ Database Configuration"
        Parameters:
          - CdbName
          - PdbName
          - OracleSid
          - CharacterSet
          - MemoryPercentage
      - Label:
          default: "ðŸ“Š Monitoring & Backup"
        Parameters:
          - EnableCloudWatch
          - EnableAutoBackup
          - BackupRetentionDays
          - AlertEmail
      - Label:
          default: "ðŸ·ï¸ Resource Tagging"
        Parameters:
          - Environment
          - ProjectName
          - CostCenter

Parameters:

  # === Network ===
  VpcId:
    Type: AWS::EC2::VPC::Id
    Description: VPC where Oracle instance will be deployed

  SubnetId:
    Type: AWS::EC2::Subnet::Id
    Description: Private subnet recommended (public subnet requires additional security hardening)

  AllowedCidrSSH:
    Type: String
    Default: 10.0.0.0/16
    Description: CIDR block for SSH access (bastion/VPN only, never 0.0.0.0/0)
    AllowedPattern: ^(\d{1,3}\.){3}\d{1,3}/\d{1,2}$
    ConstraintDescription: Must be a valid CIDR block (e.g., 10.0.0.0/16)

  AllowedCidrDB:
    Type: String
    Default: 10.0.0.0/16
    Description: CIDR block for Oracle Listener port 1521 (application tier only)
    AllowedPattern: ^(\d{1,3}\.){3}\d{1,3}/\d{1,2}$
    ConstraintDescription: Must be a valid CIDR block

  # === EC2 ===
  InstanceType:
    Type: String
    Default: m6i.xlarge
    Description: EC2 instance type (EBS-optimized required for Oracle workloads)
    AllowedValues:
      - m6i.large      # 2 vCPU, 8 GB RAM  - Dev/Test
      - m6i.xlarge     # 4 vCPU, 16 GB RAM - Small Production
      - m6i.2xlarge    # 8 vCPU, 32 GB RAM - Medium Production
      - m7i.large
      - m7i.xlarge
      - m7i.2xlarge
      - r6i.large      # Memory-optimized
      - r6i.xlarge
      - r6i.2xlarge
      - r6i.4xlarge

  KeyName:
    Type: String
    Default: ''
    Description: (Optional) EC2 Key Pair for SSH access. Leave empty to use Session Manager only (recommended)

  # === Oracle Software ===
  S3BucketName:
    Type: String
    Description: S3 bucket containing Oracle 26ai installation media
    AllowedPattern: ^[a-z0-9][a-z0-9\-]{1,61}[a-z0-9]$
    ConstraintDescription: Bucket name must be valid S3 bucket name

  S3SoftwareKey:
    Type: String
    Default: software/oracle/LINUX.X64_26AI_DB_HOME.zip
    Description: S3 object key for Oracle 26ai software ZIP file

  # === Credentials ===
  UseSecretsManager:
    Type: String
    Default: 'true'
    AllowedValues:
      - 'true'
      - 'false'
    Description: Store passwords in AWS Secrets Manager (recommended for production)

  DbSysPassword:
    NoEcho: true
    Type: String
    Default: ''
    MinLength: 0
    MaxLength: 30
    Description: SYS password (12-30 chars, alphanumeric + # _ $). Leave empty if using Secrets Manager
    AllowedPattern: ^$|^[a-zA-Z0-9#_$]{12,30}$

  DbSystemPassword:
    NoEcho: true
    Type: String
    Default: ''
    MinLength: 0
    MaxLength: 30
    Description: SYSTEM password (12-30 chars). Leave empty if using Secrets Manager
    AllowedPattern: ^$|^[a-zA-Z0-9#_$]{12,30}$

  DbPdbAdminPassword:
    NoEcho: true
    Type: String
    Default: ''
    MinLength: 0
    MaxLength: 30
    Description: PDB admin password (12-30 chars). Leave empty if using Secrets Manager
    AllowedPattern: ^$|^[a-zA-Z0-9#_$]{12,30}$

  # === Storage ===
  VolumeSizeOS:
    Type: Number
    Default: 60
    MinValue: 50
    MaxValue: 500
    Description: Root volume size (GB) - OS and system files

  VolumeSizeU01:
    Type: Number
    Default: 120
    MinValue: 100
    MaxValue: 1000
    Description: /u01 volume size (GB) - Oracle software binaries

  VolumeSizeU02:
    Type: Number
    Default: 200
    MinValue: 100
    MaxValue: 4000
    Description: /u02 volume size (GB) - Database datafiles

  VolumeSizeU03:
    Type: Number
    Default: 50
    MinValue: 20
    MaxValue: 500
    Description: /u03 volume size (GB) - Redo logs and control files

  VolumeSizeU04:
    Type: Number
    Default: 100
    MinValue: 50
    MaxValue: 2000
    Description: /u04 volume size (GB) - Fast Recovery Area (FRA)

  # === Database ===
  CdbName:
    Type: String
    Default: CDB26AI
    Description: Container Database (CDB) name (1-8 alphanumeric, must start with letter)
    AllowedPattern: ^[A-Z][A-Z0-9]{0,7}$
    ConstraintDescription: Must be 1-8 uppercase alphanumeric characters starting with a letter

  PdbName:
    Type: String
    Default: PDB26AI1
    Description: Pluggable Database (PDB) name (1-8 alphanumeric, must start with letter)
    AllowedPattern: ^[A-Z][A-Z0-9]{0,7}$

  OracleSid:
    Type: String
    Default: CDB26AI
    Description: Oracle SID (should match CdbName)
    AllowedPattern: ^[A-Z][A-Z0-9]{0,7}$

  CharacterSet:
    Type: String
    Default: AL32UTF8
    AllowedValues:
      - AL32UTF8
      - UTF8
    Description: Database character set (AL32UTF8 recommended for multi-language support)

  MemoryPercentage:
    Type: Number
    Default: 40
    MinValue: 20
    MaxValue: 80
    Description: Percentage of instance RAM allocated to Oracle SGA (40% recommended)

  # === Monitoring & Backup ===
  EnableCloudWatch:
    Type: String
    Default: 'true'
    AllowedValues:
      - 'true'
      - 'false'
    Description: Enable CloudWatch detailed monitoring and log shipping

  EnableAutoBackup:
    Type: String
    Default: 'true'
    AllowedValues:
      - 'true'
      - 'false'
    Description: Configure automatic RMAN backups to S3

  BackupRetentionDays:
    Type: Number
    Default: 7
    MinValue: 1
    MaxValue: 365
    Description: Number of days to retain backups

  AlertEmail:
    Type: String
    Default: ''
    Description: (Optional) Email for CloudWatch alarms. Leave empty to skip email notifications
    AllowedPattern: ^$|^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$

  # === Tagging ===
  Environment:
    Type: String
    Default: Development
    AllowedValues:
      - Development
      - QA
      - Staging
      - Production
    Description: Environment type for resource tagging and governance

  ProjectName:
    Type: String
    Default: Oracle26AI-Migration
    Description: Project name for cost allocation and tracking

  CostCenter:
    Type: String
    Default: IT-Database
    Description: Cost center for billing and chargeback

Conditions:
  UseKeyPair: !Not [!Equals [!Ref KeyName, '']]
  CreateSecretsManager: !Equals [!Ref UseSecretsManager, 'true']
  EnableEmailAlerts: !Not [!Equals [!Ref AlertEmail, '']]
  EnableBackups: !Equals [!Ref EnableAutoBackup, 'true']
  EnableMonitoring: !Equals [!Ref EnableCloudWatch, 'true']

Mappings:
  RegionMap:
    us-east-1:
      OracleLinux9: ami-0c02fb55b34f0ee0d  # Oracle Linux 9 - Update with actual AMI
    us-west-2:
      OracleLinux9: ami-0abcdef1234567890  # Update per region
    eu-west-1:
      OracleLinux9: ami-0abcdef1234567890

Resources:

  # === Secrets Manager (Optional) ===
  OracleDatabaseSecret:
    Type: AWS::SecretsManager::Secret
    Condition: CreateSecretsManager
    Properties:
      Name: !Sub '${AWS::StackName}/oracle/credentials'
      Description: !Sub 'Oracle Database 26ai credentials for ${AWS::StackName}'
      GenerateSecretString:
        SecretStringTemplate: '{"username":"sys"}'
        GenerateStringKey: "password"
        PasswordLength: 24
        ExcludeCharacters: '"@\/'
        RequireEachIncludedType: true
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-Oracle-Credentials'
        - Key: Environment
          Value: !Ref Environment

  # === SNS Topic for Alerts ===
  AlertTopic:
    Type: AWS::SNS::Topic
    Condition: EnableEmailAlerts
    Properties:
      DisplayName: !Sub '${AWS::StackName} Oracle Alerts'
      Subscription:
        - Endpoint: !Ref AlertEmail
          Protocol: email
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-Alerts'

  # === IAM Role ===
  OracleInstanceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${AWS::StackName}-OracleEC2-Role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
      Policies:
        - PolicyName: OracleS3Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: ListBucket
                Effect: Allow
                Action: s3:ListBucket
                Resource: !Sub 'arn:aws:s3:::${S3BucketName}'
              - Sid: GetOracleSoftware
                Effect: Allow
                Action: s3:GetObject
                Resource: !Sub 'arn:aws:s3:::${S3BucketName}/${S3SoftwareKey}'
              - Sid: BackupToS3
                Effect: Allow
                Action:
                  - s3:PutObject
                  - s3:GetObject
                  - s3:DeleteObject
                Resource: !Sub 'arn:aws:s3:::${S3BucketName}/backups/${AWS::StackName}/*'
        - !If
          - CreateSecretsManager
          - PolicyName: SecretsManagerAccess
            PolicyDocument:
              Version: '2012-10-17'
              Statement:
                - Effect: Allow
                  Action:
                    - secretsmanager:GetSecretValue
                    - secretsmanager:DescribeSecret
                  Resource: !Ref OracleDatabaseSecret
          - !Ref AWS::NoValue
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-IAM-Role'
        - Key: Environment
          Value: !Ref Environment

  OracleInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      InstanceProfileName: !Sub '${AWS::StackName}-InstanceProfile'
      Roles:
        - !Ref OracleInstanceRole

  # === Security Group ===
  OracleSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub '${AWS::StackName}-Oracle-SG'
      GroupDescription: !Sub 'Security group for Oracle 26ai - ${Environment}'
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - !If
          - UseKeyPair
          - IpProtocol: tcp
            FromPort: 22
            ToPort: 22
            CidrIp: !Ref AllowedCidrSSH
            Description: SSH from authorized network
          - !Ref AWS::NoValue
        - IpProtocol: tcp
          FromPort: 1521
          ToPort: 1521
          CidrIp: !Ref AllowedCidrDB
          Description: Oracle Listener from application tier
      SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
          Description: HTTPS for yum repos and AWS APIs
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
          Description: HTTP for yum repos
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-SG'
        - Key: Environment
          Value: !Ref Environment

  # === CloudWatch Log Group ===
  OracleLogGroup:
    Type: AWS::Logs::LogGroup
    Condition: EnableMonitoring
    Properties:
      LogGroupName: !Sub '/aws/ec2/oracle/${AWS::StackName}'
      RetentionInDays: 30

  # === EC2 Instance ===
  OracleDbInstance:
    Type: AWS::EC2::Instance
    DependsOn:
      - OracleInstanceProfile
    Properties:
      ImageId: !FindInMap [RegionMap, !Ref 'AWS::Region', OracleLinux9]
      InstanceType: !Ref InstanceType
      KeyName: !If [UseKeyPair, !Ref KeyName, !Ref AWS::NoValue]
      SubnetId: !Ref SubnetId
      IamInstanceProfile: !Ref OracleInstanceProfile
      SecurityGroupIds:
        - !Ref OracleSecurityGroup
      EbsOptimized: true
      Monitoring: !If [EnableMonitoring, true, false]
      BlockDeviceMappings:
        - DeviceName: /dev/xvda
          Ebs:
            VolumeSize: !Ref VolumeSizeOS
            VolumeType: gp3
            Iops: 3000
            Throughput: 125
            DeleteOnTermination: true
            Encrypted: true
        - DeviceName: /dev/xvdb
          Ebs:
            VolumeSize: !Ref VolumeSizeU01
            VolumeType: gp3
            Iops: 3000
            Throughput: 125
            DeleteOnTermination: false
            Encrypted: true
        - DeviceName: /dev/xvdc
          Ebs:
            VolumeSize: !Ref VolumeSizeU02
            VolumeType: gp3
            Iops: 10000
            Throughput: 500
            DeleteOnTermination: false
            Encrypted: true
        - DeviceName: /dev/xvdd
          Ebs:
            VolumeSize: !Ref VolumeSizeU03
            VolumeType: gp3
            Iops: 5000
            Throughput: 250
            DeleteOnTermination: false
            Encrypted: true
        - DeviceName: /dev/xvde
          Ebs:
            VolumeSize: !Ref VolumeSizeU04
            VolumeType: gp3
            Iops: 3000
            Throughput: 125
            DeleteOnTermination: false
            Encrypted: true
      UserData:
        Fn::Base64: !Sub
          - |
            #!/bin/bash -xe
            exec > >(tee /var/log/oracle-cfn-install.log)
            exec 2>&1
            
            set -e  # Exit on any error
            
            echo "=========================================="
            echo "Oracle 26ai CloudFormation Installation"
            echo "Stack: ${AWS::StackName}"
            echo "Region: ${AWS::Region}"
            echo "Started: $(date)"
            echo "=========================================="
            
            # FunciÃ³n para logging y errores
            log() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*"; }
            error_exit() { 
              log "ERROR: $1"
              /opt/aws/bin/cfn-signal -e 1 --stack ${AWS::StackName} --resource OracleDbInstance --region ${AWS::Region}
              exit 1
            }
            
            # === STEP 1: System Update ===
            log "Step 1: Updating system and installing prerequisites..."
            dnf -y update || error_exit "System update failed"
            dnf -y install wget zip unzip xfsprogs awscli python3-pip jq vim || error_exit "Package installation failed"
            pip3 install https://s3.amazonaws.com/cloudformation-examples/aws-cfn-bootstrap-py3-latest.tar.gz || error_exit "CFN bootstrap install failed"
            
            # === STEP 2: EBS Volumes Setup ===
            log "Step 2: Preparing EBS volumes..."
            sleep 10  # Wait for volumes to attach
            
            VOLUMES="xvdb xvdc xvdd xvde"
            FAILED_VOLS=""
            
            for dev in $VOLUMES; do
              if [ -b /dev/$dev ]; then
                log "Processing /dev/$dev"
                parted /dev/$dev --script mklabel gpt mkpart primary 0% 100% || FAILED_VOLS="$FAILED_VOLS $dev"
                mkfs.xfs -f /dev/${!dev}1 || FAILED_VOLS="$FAILED_VOLS $dev"
              else
                FAILED_VOLS="$FAILED_VOLS $dev"
              fi
            done
            
            [ -n "$FAILED_VOLS" ] && error_exit "Failed to prepare volumes:$FAILED_VOLS"
            
            # Create mount points
            mkdir -p /u01 /u02 /u03 /u04
            
            # Add to fstab using UUIDs (more reliable)
            echo "UUID=$(blkid -s UUID -o value /dev/xvdb1) /u01 xfs defaults,nofail 0 0" >> /etc/fstab
            echo "UUID=$(blkid -s UUID -o value /dev/xvdc1) /u02 xfs defaults,nofail 0 0" >> /etc/fstab
            echo "UUID=$(blkid -s UUID -o value /dev/xvdd1) /u03 xfs defaults,nofail 0 0" >> /etc/fstab
            echo "UUID=$(blkid -s UUID -o value /dev/xvde1) /u04 xfs defaults,nofail 0 0" >> /etc/fstab
            
            mount -a || error_exit "Failed to mount filesystems"
            
            # Verify all mounts
            for mp in /u01 /u02 /u03 /u04; do
              mountpoint -q $mp || error_exit "$mp is not mounted"
            done
            
            log "All volumes mounted successfully"
            df -h | grep /u0
            
            # === STEP 3: Hostname and Network ===
            log "Step 3: Configuring hostname and network..."
            PRIVATE_IP=$(curl -s http://169.254.169.254/latest/meta-data/local-ipv4)
            HOSTNAME="oracle-${!PRIVATE_IP//./-}"
            hostnamectl set-hostname "$HOSTNAME"
            echo "$PRIVATE_IP ${!HOSTNAME}.ec2.internal $HOSTNAME localhost" >> /etc/hosts
            log "Hostname set to: $HOSTNAME ($PRIVATE_IP)"
            
            # === STEP 4: Oracle Preinstall Package ===
            log "Step 4: Installing Oracle 26ai preinstall package..."
            PREINSTALL_RPM="oracle-ai-database-preinstall-26ai-1.0-1.el9.x86_64.rpm"
            curl -o /tmp/$PREINSTALL_RPM \
              "https://yum.oracle.com/repo/OracleLinux/OL9/appstream/x86_64/getPackage/$PREINSTALL_RPM" \
              || error_exit "Failed to download Oracle preinstall RPM"
            
            dnf -y localinstall /tmp/$PREINSTALL_RPM || error_exit "Oracle preinstall package installation failed"
            log "Oracle user and groups configured successfully"
            
            # === STEP 5: Directory Structure ===
            log "Step 5: Creating Oracle directory structure..."
            mkdir -p /u01/app/oracle/product/26ai/dbhome_1
            mkdir -p /u01/app/oraInventory
            mkdir -p /u02/oradata
            mkdir -p /u03/redolog
            mkdir -p /u04/fra
            mkdir -p /u01/software
            mkdir -p /u01/scripts
            mkdir -p /u01/backups
            
            chown -R oracle:oinstall /u01 /u02 /u03 /u04
            chmod -R 775 /u01 /u02 /u03 /u04
            
            # === STEP 6: Get Passwords ===
            log "Step 6: Retrieving database credentials..."
            if [ "${UseSecretsManager}" = "true" ]; then
              log "Using AWS Secrets Manager for passwords"
              SECRET_JSON=$(aws secretsmanager get-secret-value --secret-id ${SecretArn} --region ${AWS::Region} --query SecretString --output text)
              SYS_PWD=$(echo $SECRET_JSON | jq -r '.password')
              SYSTEM_PWD=$SYS_PWD  # Same password for simplicity
              PDB_PWD=$SYS_PWD
            else
              log "Using CloudFormation parameters for passwords"
              SYS_PWD="${SysPassword}"
              SYSTEM_PWD="${SystemPassword}"
              PDB_PWD="${PdbPassword}"
            fi
            
            # Validate passwords are not empty
            [ -z "$SYS_PWD" ] && error_exit "SYS password is empty"
            
            # === STEP 7: Download Oracle Software ===
            log "Step 7: Downloading Oracle 26ai software from S3..."
            aws s3 cp s3://${S3BucketName}/${S3SoftwareKey} /u01/software/LINUX.X64_26AI_DB_HOME.zip \
              || error_exit "Failed to download Oracle software from S3"
            
            chown oracle:oinstall /u01/software/LINUX.X64_26AI_DB_HOME.zip
            
            # Verify download
            FILE_SIZE=$(stat -f%z /u01/software/LINUX.X64_26AI_DB_HOME.zip 2>/dev/null || stat -c%s /u01/software/LINUX.X64_26AI_DB_HOME.zip)
            log "Downloaded file size: $FILE_SIZE bytes"
            [ "$FILE_SIZE" -lt 1000000 ] && error_exit "Downloaded file is too small, likely corrupted"
            
            # === STEP 8: Extract Software ===
            log "Step 8: Extracting Oracle software (this may take 5-10 minutes)..."
            su - oracle -c "
              set -e
              cd /u01/app/oracle/product/26ai/dbhome_1
              unzip -q /u01/software/LINUX.X64_26AI_DB_HOME.zip
            " || error_exit "Failed to extract Oracle software"
            
            log "Oracle software extracted successfully"
            
            # === STEP 9: Create Response File ===
            log "Step 9: Creating OUI response file..."
            cat > /u01/software/db_install.rsp << 'EOFRSP'
            oracle.install.responseFileVersion=/oracle/install/rspfmt_dbinstall_response_schema_v26.0.0
            oracle.install.option=INSTALL_DB_SWONLY
            UNIX_GROUP_NAME=oinstall
            INVENTORY_LOCATION=/u01/app/oraInventory
            ORACLE_HOME=/u01/app/oracle/product/26ai/dbhome_1
            ORACLE_BASE=/u01/app/oracle
            oracle.install.db.InstallEdition=EE
            oracle.install.db.OSDBA_GROUP=dba
            oracle.install.db.OSOPER_GROUP=oper
            oracle.install.db.OSBACKUPDBA_GROUP=backupdba
            oracle.install.db.OSDGDBA_GROUP=dgdba
            oracle.install.db.OSKMDBA_GROUP=kmdba
            oracle.install.db.OSRACDBA_GROUP=racdba
            DECLINE_SECURITY_UPDATES=true
            EOFRSP
            
            chown oracle:oinstall /u01/software/db_install.rsp
            
            # === STEP 10: Run OUI (Oracle Universal Installer) ===
            log "Step 10: Running Oracle Universal Installer (silent mode - 15-20 min)..."
            su - oracle -c "
              set -e
              export ORACLE_HOME=/u01/app/oracle/product/26ai/dbhome_1
              cd \$ORACLE_HOME
              ./runInstaller -silent -responseFile /u01/software/db_install.rsp -ignorePrereqFailure -waitforcompletion
            " || error_exit "Oracle Universal Installer failed"
            
            log "OUI installation completed successfully"
            
            # === STEP 11: Execute Root Scripts (CRITICAL - Must run before DBCA) ===
            log "Step 11: Executing Oracle root configuration scripts..."
            /u01/app/oraInventory/orainstRoot.sh || error_exit "orainstRoot.sh failed"
            /u01/app/oracle/product/26ai/dbhome_1/root.sh || error_exit "root.sh failed"
            log "Root scripts executed successfully"
            
            # === STEP 12: Create Database with DBCA ===
            log "Step 12: Creating database with DBCA (this takes 20-30 minutes)..."
            su - oracle -c "
              set -e
              export ORACLE_BASE=/u01/app/oracle
              export ORACLE_HOME=/u01/app/oracle/product/26ai/dbhome_1
              export ORACLE_SID=${OracleSid}
              export PATH=\$ORACLE_HOME/bin:\$PATH
              
              dbca -silent -createDatabase \
                -templateName General_Purpose.dbc \
                -gdbName ${CdbName} \
                -sid ${OracleSid} \
                -createAsContainerDatabase true \
                -numberOfPDBs 1 \
                -pdbName ${PdbName} \
                -sysPassword '$SYS_PWD' \
                -systemPassword '$SYSTEM_PWD' \
                -pdbAdminPassword '$PDB_PWD' \
                -characterSet ${CharacterSet} \
                -nationalCharacterSet AL16UTF16 \
                -memoryMgmtType auto_sga \
                -memoryPercentage ${MemoryPercentage} \
                -emConfiguration NONE \
                -storageType FS \
                -datafileDestination /u02/oradata \
                -redoLogFileSize 200 \
                -recoveryAreaDestination /u04/fra \
                -recoveryAreaSize 50 \
                -ignorePreReqs
            " || error_exit "DBCA failed"
            
            log "Database creation completed successfully"
            
            # === STEP 13: Configure Listener ===
            log "Step 13: Configuring Oracle Listener..."
            su - oracle -c "
              set -e
              export ORACLE_HOME=/u01/app/oracle/product/26ai/dbhome_1
              export PATH=\$ORACLE_HOME/bin:\$PATH
              
              lsnrctl stop || true
              lsnrctl start
              lsnrctl status
            " || error_exit "Listener configuration failed"
            
            # === STEP 14: Configure Oracle Environment ===
            log "Step 14: Configuring Oracle user environment..."
            su - oracle -c "
            cat >> ~/.bash_profile << 'EOFPROFILE'
            # Oracle Environment Variables
            export ORACLE_BASE=/u01/app/oracle
            export ORACLE_HOME=/u01/app/oracle/product/26ai/dbhome_1
            export ORACLE_SID=${OracleSid}
            export PATH=\$ORACLE_HOME/bin:\$PATH
            export LD_LIBRARY_PATH=\$ORACLE_HOME/lib:\$LD_LIBRARY_PATH
            export CLASSPATH=\$ORACLE_HOME/jlib:\$ORACLE_HOME/rdbms/jlib
            
            # Aliases
            alias sqlplus='rlwrap sqlplus'
            alias rman='rlwrap rman'
            EOFPROFILE
            "
            
            # === STEP 15: Create Autostart Service ===
            log "Step 15: Creating systemd service for Oracle autostart..."
            cat > /etc/systemd/system/oracle-database.service << 'EOFSVC'
            [Unit]
            Description=Oracle Database 26ai Service
            After=network.target local-fs.target
            
            [Service]
            Type=forking
            User=oracle
            Group=oinstall
            Restart=on-failure
            RestartSec=30
            ExecStart=/u01/scripts/oracle-start.sh
            ExecStop=/u01/scripts/oracle-stop.sh
            RemainAfterExit=yes
            
            [Install]
            WantedBy=multi-user.target
            EOFSVC
            
            # Create startup script
            cat > /u01/scripts/oracle-start.sh << EOFSTART
            #!/bin/bash
            export ORACLE_BASE=/u01/app/oracle
            export ORACLE_HOME=/u01/app/oracle/product/26ai/dbhome_1
            export ORACLE_SID=${OracleSid}
            export PATH=\$ORACLE_HOME/bin:\$PATH
            
            lsnrctl start
            sqlplus / as sysdba << EOF
            STARTUP;
            ALTER PLUGGABLE DATABASE ALL OPEN;
            EXIT;
            EOF
            EOFSTART
            
            # Create shutdown script
            cat > /u01/scripts/oracle-stop.sh << EOFSTOP
            #!/bin/bash
            export ORACLE_BASE=/u01/app/oracle
            export ORACLE_HOME=/u01/app/oracle/product/26ai/dbhome_1
            export ORACLE_SID=${OracleSid}
            export PATH=\$ORACLE_HOME/bin:\$PATH
            
            sqlplus / as sysdba << EOF
            ALTER PLUGGABLE DATABASE ALL CLOSE IMMEDIATE;
            SHUTDOWN IMMEDIATE;
            EXIT;
            EOF
            lsnrctl stop
            EOFSTOP
            
            chmod +x /u01/scripts/*.sh
            chown oracle:oinstall /u01/scripts/*.sh
            
            systemctl daemon-reload
            systemctl enable oracle-database
            log "Oracle autostart service configured"
            
            # === STEP 16: Database Validation ===
            log "Step 16: Validating Oracle installation..."
            su - oracle -c "
              export ORACLE_SID=${OracleSid}
              export ORACLE_HOME=/u01/app/oracle/product/26ai/dbhome_1
              export PATH=\$ORACLE_HOME/bin:\$PATH
              
              sqlplus -s / as sysdba << 'EOFSQL'
              SET PAGESIZE 0 FEEDBACK OFF VERIFY OFF HEADING OFF ECHO OFF
              SELECT 'Database Version: ' || banner FROM v\$version WHERE ROWNUM = 1;
              SELECT 'Database Name: ' || name FROM v\$database;
              SELECT 'Database Status: ' || status FROM v\$instance;
              SELECT 'CDB: ' || cdb FROM v\$database;
              SELECT 'PDB Status: ' || name || ' - ' || open_mode FROM v\$pdbs;
              EXIT;
              EOFSQL
            " | tee /var/log/oracle-validation.log
            
            # Check if validation was successful
            grep -q "READ WRITE" /var/log/oracle-validation.log || error_exit "Database validation failed - PDB not in READ WRITE mode"
            
            log "Database validation successful"
            
            # === STEP 17: RMAN Backup Configuration (Optional) ===
            if [ "${EnableBackups}" = "true" ]; then
              log "Step 17: Configuring RMAN backups..."
              su - oracle -c "
                export ORACLE_SID=${OracleSid}
                export ORACLE_HOME=/u01/app/oracle/product/26ai/dbhome_1
                export PATH=\$ORACLE_HOME/bin:\$PATH
                
                rman target / << 'EOFRMAN'
                CONFIGURE RETENTION POLICY TO RECOVERY WINDOW OF ${BackupRetentionDays} DAYS;
                CONFIGURE CONTROLFILE AUTOBACKUP ON;
                CONFIGURE CONTROLFILE AUTOBACKUP FORMAT FOR DEVICE TYPE DISK TO '/u04/fra/%F';
                CONFIGURE DEVICE TYPE DISK BACKUP TYPE TO COMPRESSED BACKUPSET;
                CONFIGURE COMPRESSION ALGORITHM 'MEDIUM';
                EXIT;
                EOFRMAN
              "
              log "RMAN backup configuration completed"
            fi
            
            # === FINAL: Signal Success ===
            log "=========================================="
            log "Oracle 26ai installation completed successfully!"
            log "Completed at: $(date)"
            log "=========================================="
            
            /opt/aws/bin/cfn-signal -e 0 --stack ${AWS::StackName} --resource OracleDbInstance --region ${AWS::Region}
            
          - SecretArn: !If [CreateSecretsManager, !Ref OracleDatabaseSecret, '']
            SysPassword: !Ref DbSysPassword
            SystemPassword: !Ref DbSystemPassword
            PdbPassword: !Ref DbPdbAdminPassword
            EnableBackups: !Ref EnableAutoBackup

      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-Oracle26ai-${Environment}'
        - Key: Environment
          Value: !Ref Environment
        - Key: Project
          Value: !Ref ProjectName
        - Key: CostCenter
          Value: !Ref CostCenter
        - Key: Database
          Value: Oracle-26ai-Enterprise
        - Key: ManagedBy
          Value: CloudFormation
        - Key: BackupEnabled
          Value: !Ref EnableAutoBackup

    CreationPolicy:
      ResourceSignal:
        Count: 1
        Timeout: PT120M

  # === CloudWatch Alarms ===
  HighCPUAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: EnableMonitoring
    Properties:
      AlarmName: !Sub '${AWS::StackName}-HighCPU'
      AlarmDescription: Alert when CPU exceeds 80%
      MetricName: CPUUtilization
      Namespace: AWS/EC2
      Statistic: Average
      Period: 300
      EvaluationPeriods: 2
      Threshold: 80
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: InstanceId
          Value: !Ref OracleDbInstance
      AlarmActions: !If [EnableEmailAlerts, [!Ref AlertTopic], []]

  LowDiskSpaceAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: EnableMonitoring
    Properties:
      AlarmName: !Sub '${AWS::StackName}-LowDiskSpace'
      AlarmDescription: Alert when disk usage exceeds 85%
      MetricName: disk_used_percent
      Namespace: CWAgent
      Statistic: Average
      Period: 300
      EvaluationPeriods: 1
      Threshold: 85
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: InstanceId
          Value: !Ref OracleDbInstance
        - Name: path
          Value: /u02
      AlarmActions: !If [EnableEmailAlerts, [!Ref AlertTopic], []]

Outputs:

  InstanceId:
    Description: EC2 Instance ID
    Value: !Ref OracleDbInstance
    Export:
      Name: !Sub '${AWS::StackName}-InstanceId'

  PrivateIp:
    Description: Private IP address of Oracle instance
    Value: !GetAtt OracleDbInstance.PrivateIp
    Export:
      Name: !Sub '${AWS::StackName}-PrivateIp'

  CdbConnectString:
    Description: Connection string for Container Database (CDB)
    Value: !Sub '//${OracleDbInstance.PrivateIp}:1521/${CdbName}'
    Export:
      Name: !Sub '${AWS::StackName}-CDB-Connect'

  PdbConnectString:
    Description: Connection string for Pluggable Database (PDB) - Use this for applications
    Value: !Sub '//${OracleDbInstance.PrivateIp}:1521/${PdbName}'
    Export:
      Name: !Sub '${AWS::StackName}-PDB-Connect'

  SecurityGroupId:
    Description: Security Group ID for Oracle instance
    Value: !Ref OracleSecurityGroup
    Export:
      Name: !Sub '${AWS::StackName}-SecurityGroup'

  SecretArn:
    Description: Secrets Manager ARN for database credentials
    Condition: CreateSecretsManager
    Value: !Ref OracleDatabaseSecret
    Export:
      Name: !Sub '${AWS::StackName}-SecretArn'

  OracleHome:
    Description: Oracle Home directory path
    Value: /u01/app/oracle/product/26ai/dbhome_1

  InstallationLog:
    Description: Installation log file location
    Value: /var/log/oracle-cfn-install.log

  ValidationLog:
    Description: Database validation log
    Value: /var/log/oracle-validation.log

  ConnectViaSQLPlus:
    Description: Example SQLPlus connection command (from instance)
    Value: !Sub 'sudo su - oracle -c "sqlplus sys@${CdbName} as sysdba"'

  ConnectViaSessionManager:
    Description: AWS Systems Manager Session Manager command
    Value: !Sub 'aws ssm start-session --target ${OracleDbInstance}'

  BackupLocation:
    Description: S3 location for RMAN backups
    Condition: EnableBackups
    Value: !Sub 's3://${S3BucketName}/backups/${AWS::StackName}/'

  QuickStartGuide:
    Description: Next steps after deployment
    Value: !Sub |
      1. Connect via Session Manager: aws ssm start-session --target ${OracleDbInstance}
      2. Switch to oracle user: sudo su - oracle
      3. Connect to database: sqlplus / as sysdba
      4. Verify PDB: SELECT name, open_mode FROM v$pdbs;
      5. Installation logs: tail -f /var/log/oracle-cfn-install.log
